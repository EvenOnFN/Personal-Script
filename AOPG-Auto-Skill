-- Load Linoria Library
local repo = 'https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/main/'
local Library = loadstring(game:HttpGet(repo .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(repo .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(repo .. 'addons/SaveManager.lua'))()

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Anti-AFK Setup
local VirtualUser = game:GetService("VirtualUser")
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- Create Window
local Window = Library:CreateWindow({
    Title = 'Auto Skills',
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})

-- Create Tab
local Tabs = {
    Main = Window:AddTab('Main'),
}

-- Variables
local autoQEnabled = false
local autoEEnabled = false
local autoTPQEnabled = false
local autoM1Enabled = false
local autoSmartGachaEnabled = false
local autoSmartGemCapEnabled = false
local autoDragonSummonEnabled = false
local autoDragonKillerEnabled = false
local qConnection, eConnection, tpqConnection, m1Connection, smartGachaConnection, smartGemCapConnection, dragonSummonConnection, dragonKillerConnection = nil, nil, nil, nil, nil, nil, nil, nil
local lastQAttackTime, lastEAttackTime, lastTPQAttackTime, lastDragonSummonTime, lastDragonQTime, lastDragonETime = 0, 0, 0, 0, 0, 0
local attackDelay = 0.1
local dragonSummonDelay = 1
local tpHeight = 5

-- Toggle references
local GachaToggle = nil
local GemCapToggle = nil
local DragonToggle = nil

-- Main Tab Groups
local EscanorSkillGroup = Tabs.Main:AddLeftGroupbox('Escanor')
local TPFarmGroup = Tabs.Main:AddRightGroupbox('TP Farm')
local M1Group = Tabs.Main:AddRightGroupbox('Auto M1')
local ShopsGroup = Tabs.Main:AddLeftGroupbox('Shops')
local DragonSummonGroup = Tabs.Main:AddLeftGroupbox('Auto Dragon Summon')
local DragonKillerGroup = Tabs.Main:AddRightGroupbox('Fire Dragon Killer')

-- Function to get Present currency
local function getPresentCurrency()
    local currency = 0
    pcall(function()
        local stats = player:FindFirstChild("Stats")
        if stats and stats:FindFirstChild("Present") then
            currency = stats.Present.Value
        end
    end)
    return currency
end

-- Function to get Poneglyph currency
local function getPoneglyphCurrency()
    local currency = 0
    pcall(function()
        local stats = player:FindFirstChild("Stats")
        if stats and stats:FindFirstChild("Poneglyphs") then
            currency = stats.Poneglyphs.Value
        end
    end)
    return currency
end

-- Function to check if player has Fire Dragon Key
local function hasFireDragonKey()
    local hasKey = false
    pcall(function()
        local backpack = player:FindFirstChild("Backpack")
        if backpack and backpack:FindFirstChild("Fire Dragon Key") then
            hasKey = true
            return
        end
        
        -- Also check character (if equipped)
        local character = player.Character
        if character and character:FindFirstChild("Fire Dragon Key") then
            hasKey = true
        end
    end)
    return hasKey
end

-- Function to check if model has NpcMarker
local function hasNpcMarker(model)
    for _, child in pairs(model:GetDescendants()) do
        if child:IsA("BillboardGui") and child.Name == "NpcMarker" then
            return true
        end
    end
    return false
end

-- Function to check if something is a raid mob
local function isRaidMob(model)
    if not model:IsA("Model") then return false end
    if not model:FindFirstChild("Humanoid") then return false end
    if not model:FindFirstChild("HumanoidRootPart") then return false end
    if Players:GetPlayerFromCharacter(model) then return false end
    local humanoid = model:FindFirstChild("Humanoid")
    if humanoid.Health <= 0 then return false end
    if not hasNpcMarker(model) then return false end
    return true
end

-- Function to check if something is the Fire Dragon boss
local function isFireDragon(model)
    if not model:IsA("Model") then return false end
    if not model:FindFirstChild("Humanoid") then return false end
    if not model:FindFirstChild("HumanoidRootPart") then return false end
    
    local humanoid = model:FindFirstChild("Humanoid")
    if humanoid.Health <= 0 then return false end
    
    -- Check if name contains "Volcanic Blast Breath Boss" or similar
    local name = model.Name
    if name:find("Volcanic") or name:find("Blast") or name:find("Breath") or name:find("Boss") then
        return true
    end
    
    return false
end

-- Function to find Fire Dragon
local function findFireDragon()
    if workspace:FindFirstChild("Entities") then
        for _, model in pairs(workspace.Entities:GetChildren()) do
            if isFireDragon(model) then
                return model
            end
        end
    end
    return nil
end

-- Function to find nearest raid mob
local function findNearestRaidMob()
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        return nil
    end
    local playerPos = player.Character.HumanoidRootPart.Position
    local nearestMob, nearestDistance = nil, math.huge
    if workspace:FindFirstChild("Entities") then
        for _, model in pairs(workspace.Entities:GetChildren()) do
            if isRaidMob(model) then
                local mobHRP = model:FindFirstChild("HumanoidRootPart")
                if mobHRP then
                    local distance = (playerPos - mobHRP.Position).Magnitude
                    if distance < nearestDistance then
                        nearestDistance = distance
                        nearestMob = model
                    end
                end
            end
        end
    end
    return nearestMob
end

-- Function to get a suitable target part for abilities
local function getTargetPart()
    if workspace:FindFirstChild("Raid Map") then
        for _, child in pairs(workspace["Raid Map"]:GetChildren()) do
            if child:IsA("MeshPart") and child.Name:find("newcake") then return child end
        end
        for _, child in pairs(workspace["Raid Map"]:GetChildren()) do
            if child:IsA("MeshPart") then return child end
        end
        if workspace["Raid Map"]:FindFirstChild("Model") then return workspace["Raid Map"].Model end
    else
        local dawnIsland = workspace:FindFirstChild("Map") and workspace.Map:FindFirstChild("Islands") and workspace.Map.Islands:FindFirstChild("Dawn Island")
        if dawnIsland and dawnIsland:FindFirstChild("Model") then
            local model = dawnIsland.Model:FindFirstChild("Dawn Island")
            if model and model:FindFirstChild("Model") then
                local meshPart = model.Model:FindFirstChild("Meshes/daniland.2")
                if meshPart then return meshPart end
            end
        end
    end
    return workspace
end

-- Function to get skill args
local function getSkillArgs(skill)
    return {
        "Sword Style",
        skill,
        player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.HumanoidRootPart.CFrame or CFrame.new(0, 0, 0),
        getTargetPart(),
        5
    }
end

-- Function to teleport to position
local function teleportToPosition(targetPosition)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        player.Character.HumanoidRootPart.CFrame = CFrame.new(targetPosition)
    end
end

-- Function to perform M1 attack
local function performM1()
    pcall(function()
        ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("MouseButton1")))
    end)
end

-- Smart buy gacha based on currency (automatically checks live)
local function smartBuyGacha()
    pcall(function()
        local presents = getPresentCurrency()
        local version = 1
        
        if presents >= 1000 then
            version = 3
        elseif presents >= 500 then
            version = 2
        elseif presents >= 100 then
            version = 1
        else
            -- Not enough currency, disable
            autoSmartGachaEnabled = false
            if smartGachaConnection then
                smartGachaConnection:Disconnect()
                smartGachaConnection = nil
            end
            if GachaToggle then
                GachaToggle:SetValue(false)
            end
            Library:Notify('‚ùå Christmas Gacha disabled - Not enough presents!')
            return
        end
        
        player:WaitForChild("PlayerGui"):WaitForChild("NewPresentShop"):WaitForChild("buy"):FireServer(version)
    end)
end

-- Smart increase gem cap based on currency (automatically checks live)
local function smartIncreaseGemCap()
    pcall(function()
        local poneglyphs = getPoneglyphCurrency()
        
        -- Stop at 1 poneglyph since it's bugged
        if poneglyphs <= 1 then
            -- Not enough currency, disable
            autoSmartGemCapEnabled = false
            if smartGemCapConnection then
                smartGemCapConnection:Disconnect()
                smartGemCapConnection = nil
            end
            if GemCapToggle then
                GemCapToggle:SetValue(false)
            end
            Library:Notify('‚ùå Gem Cap disabled - Down to last poneglyph!')
            return
        end
        
        local amount = 1
        
        if poneglyphs >= 10 then
            amount = 10
        elseif poneglyphs >= 5 then
            amount = 5
        else
            amount = 1
        end
        
        player:WaitForChild("PlayerGui"):WaitForChild("NewPoneglyphMerchant"):WaitForChild("Event"):FireServer(amount)
    end)
end

-- Function to summon dragon
local function summonDragon()
    pcall(function()
        local currentTime = tick()
        
        -- Check delay
        if currentTime - lastDragonSummonTime < dragonSummonDelay then
            return
        end
        
        -- Check if player has Fire Dragon Key
        if not hasFireDragonKey() then
            -- No keys left, disable
            autoDragonSummonEnabled = false
            if dragonSummonConnection then
                dragonSummonConnection:Disconnect()
                dragonSummonConnection = nil
            end
            if DragonToggle then
                DragonToggle:SetValue(false)
            end
            
            -- Close any open Dragon Summoner GUI
            local gui = player:FindFirstChild("PlayerGui")
            if gui then
                local dragonSummoner = gui:FindFirstChild("Dragon Summoner")
                if dragonSummoner then
                    dragonSummoner:Destroy()
                end
            end
            
            Library:Notify('‚ùå Dragon Summon disabled - Out of Fire Dragon Keys!')
            return
        end
        
        -- Open GUI
        ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("clonegui"):FireServer("Dragon Summoner")
        wait(0.3)
        
        -- Confirm summon
        local gui = player:WaitForChild("PlayerGui")
        local dragonSummoner = gui:FindFirstChild("Dragon Summoner")
        if dragonSummoner then
            local eventRemote = dragonSummoner:FindFirstChild("Event")
            if eventRemote then
                eventRemote:FireServer()
                wait(0.1)
                dragonSummoner:Destroy()
            end
        end
        
        lastDragonSummonTime = currentTime
    end)
end

-- Toggle for Auto Q Skill
EscanorSkillGroup:AddToggle('AutoQ', {
    Text = 'Escanor Q',
    Default = false,
    Tooltip = 'Automatically uses Q skill when raid mob detected',
    Callback = function(value)
        autoQEnabled = value
        if value then
            Library:Notify('‚úÖ Escanor Q enabled!')
            qConnection = RunService.Heartbeat:Connect(function()
                if not autoQEnabled then return end
                local mob = findNearestRaidMob()
                if mob and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
                    local currentTime = tick()
                    if currentTime - lastQAttackTime >= attackDelay then
                        pcall(function()
                            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("Q")))
                        end)
                        lastQAttackTime = currentTime
                    end
                end
            end)
        else
            Library:Notify('‚ùå Escanor Q disabled.')
            if qConnection then qConnection:Disconnect() qConnection = nil end
        end
    end
})

EscanorSkillGroup:AddDivider()

-- Toggle for Auto E Skill
EscanorSkillGroup:AddToggle('AutoE', {
    Text = 'Escanor E',
    Default = false,
    Tooltip = 'Automatically uses E skill when raid mob detected',
    Callback = function(value)
        autoEEnabled = value
        if value then
            Library:Notify('‚úÖ Escanor E enabled!')
            eConnection = RunService.Heartbeat:Connect(function()
                if not autoEEnabled then return end
                local mob = findNearestRaidMob()
                if mob and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
                    local currentTime = tick()
                    if currentTime - lastEAttackTime >= attackDelay then
                        pcall(function()
                            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("E")))
                        end)
                        lastEAttackTime = currentTime
                    end
                end
            end)
        else
            Library:Notify('‚ùå Escanor E disabled.')
            if eConnection then eConnection:Disconnect() eConnection = nil end
        end
    end
})

EscanorSkillGroup:AddDivider()
EscanorSkillGroup:AddLabel('Attacks mobs with NpcMarker')
EscanorSkillGroup:AddLabel('No teleportation')
EscanorSkillGroup:AddDivider()
EscanorSkillGroup:AddLabel('üü¢ Anti-AFK: Active')

-- Toggle for Auto TP + Q Farm
TPFarmGroup:AddToggle('AutoTPQ', {
    Text = 'Auto TP + Q Farm',
    Default = false,
    Tooltip = 'Teleports to raid mob and uses Q skill',
    Callback = function(value)
        autoTPQEnabled = value
        if value then
            Library:Notify('‚úÖ Auto TP + Q Farm enabled!')
            tpqConnection = RunService.Heartbeat:Connect(function()
                if not autoTPQEnabled then return end
                local mob = findNearestRaidMob()
                if mob and mob:FindFirstChild("Humanoid") and mob:FindFirstChild("HumanoidRootPart") and mob.Humanoid.Health > 0 then
                    teleportToPosition(mob.HumanoidRootPart.Position + Vector3.new(0, tpHeight, 0))
                    local currentTime = tick()
                    if currentTime - lastTPQAttackTime >= attackDelay then
                        pcall(function()
                            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("Q")))
                        end)
                        lastTPQAttackTime = currentTime
                    end
                end
            end)
        else
            Library:Notify('‚ùå Auto TP + Q Farm disabled.')
            if tpqConnection then tpqConnection:Disconnect() tpqConnection = nil end
        end
    end
})

TPFarmGroup:AddDivider()
TPFarmGroup:AddLabel('Teleports to mob')
TPFarmGroup:AddLabel('Uses Q skill')

-- Toggle for Auto M1
M1Group:AddToggle('AutoM1', {
    Text = 'Auto M1 (Sword Style)',
    Default = false,
    Tooltip = 'Automatically spams Sword Style M1 at all times',
    Callback = function(value)
        autoM1Enabled = value
        if value then
            Library:Notify('‚úÖ Auto M1 enabled!')
            m1Connection = RunService.Heartbeat:Connect(function()
                if not autoM1Enabled then return end
                performM1()
            end)
        else
            Library:Notify('‚ùå Auto M1 disabled.')
            if m1Connection then m1Connection:Disconnect() m1Connection = nil end
        end
    end
})

M1Group:AddDivider()
M1Group:AddLabel('Uses Sword Style M1')
M1Group:AddLabel('Spams constantly')

-- Toggle for Smart Buy Gacha
GachaToggle = ShopsGroup:AddToggle('AutoSmartGacha', {
    Text = 'Smart Christmas Gacha',
    Default = false,
    Tooltip = 'Auto-detects Presents and buys the best option',
    Callback = function(value)
        autoSmartGachaEnabled = value
        if value then
            local presents = getPresentCurrency()
            Library:Notify('‚úÖ Smart Gacha enabled! (' .. presents .. ' presents)')
            smartGachaConnection = RunService.Heartbeat:Connect(function()
                if not autoSmartGachaEnabled then return end
                smartBuyGacha()
            end)
        else
            Library:Notify('‚ùå Smart Christmas Gacha disabled.')
            if smartGachaConnection then smartGachaConnection:Disconnect() smartGachaConnection = nil end
        end
    end
})

ShopsGroup:AddDivider()

-- Toggle for Smart Increase Gem Cap
GemCapToggle = ShopsGroup:AddToggle('AutoSmartGemCap', {
    Text = 'Smart Gem Cap Increase',
    Default = false,
    Tooltip = 'Auto-detects Poneglyphs and buys the best option (stops at 1)',
    Callback = function(value)
        autoSmartGemCapEnabled = value
        if value then
            local poneglyphs = getPoneglyphCurrency()
            Library:Notify('‚úÖ Smart Gem Cap enabled! (' .. poneglyphs .. ' poneglyphs)')
            smartGemCapConnection = RunService.Heartbeat:Connect(function()
                if not autoSmartGemCapEnabled then return end
                smartIncreaseGemCap()
            end)
        else
            Library:Notify('‚ùå Smart Gem Cap disabled.')
            if smartGemCapConnection then smartGemCapConnection:Disconnect() smartGemCapConnection = nil end
        end
    end
})

-- Toggle for Auto Dragon Summon
DragonToggle = DragonSummonGroup:AddToggle('AutoDragonSummon', {
    Text = 'Auto Dragon Summon',
    Default = false,
    Tooltip = 'Auto-summons dragon (1s delay, stops when out of keys)',
    Callback = function(value)
        autoDragonSummonEnabled = value
        if value then
            Library:Notify('‚úÖ Auto Dragon Summon enabled!')
            dragonSummonConnection = RunService.Heartbeat:Connect(function()
                if not autoDragonSummonEnabled then return end
                summonDragon()
            end)
        else
            Library:Notify('‚ùå Auto Dragon Summon disabled.')
            if dragonSummonConnection then dragonSummonConnection:Disconnect() dragonSummonConnection = nil end
        end
    end
})

DragonSummonGroup:AddDivider()
DragonSummonGroup:AddLabel('1 second delay per summon')
DragonSummonGroup:AddLabel('Auto-stops when out of keys')

-- Toggle for Fire Dragon Q
DragonKillerGroup:AddToggle('AutoDragonQ', {
    Text = 'Dragon Killer Q',
    Default = false,
    Tooltip = 'Uses Q skill on Fire Dragon boss',
    Callback = function(value)
        autoDragonKillerEnabled = value
        if value then
            Library:Notify('‚úÖ Dragon Killer Q enabled!')
            dragonKillerConnection = RunService.Heartbeat:Connect(function()
                if not autoDragonKillerEnabled then return end
                local dragon = findFireDragon()
                if dragon and dragon:FindFirstChild("Humanoid") and dragon.Humanoid.Health > 0 then
                    local currentTime = tick()
                    if currentTime - lastDragonQTime >= attackDelay then
                        pcall(function()
                            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("Q")))
                        end)
                        lastDragonQTime = currentTime
                    end
                end
            end)
        else
            Library:Notify('‚ùå Dragon Killer Q disabled.')
            if dragonKillerConnection then dragonKillerConnection:Disconnect() dragonKillerConnection = nil end
        end
    end
})

DragonKillerGroup:AddDivider()

-- Toggle for Fire Dragon E
DragonKillerGroup:AddToggle('AutoDragonE', {
    Text = 'Dragon Killer E',
    Default = false,
    Tooltip = 'Uses E skill on Fire Dragon boss',
    Callback = function(value)
        local dragonEConnection = nil
        if value then
            Library:Notify('‚úÖ Dragon Killer E enabled!')
            dragonEConnection = RunService.Heartbeat:Connect(function()
                local dragon = findFireDragon()
                if dragon and dragon:FindFirstChild("Humanoid") and dragon.Humanoid.Health > 0 then
                    local currentTime = tick()
                    if currentTime - lastDragonETime >= attackDelay then
                        pcall(function()
                            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("E")))
                        end)
                        lastDragonETime = currentTime
                    end
                end
            end)
        else
            Library:Notify('‚ùå Dragon Killer E disabled.')
            if dragonEConnection then dragonEConnection:Disconnect() dragonEConnection = nil end
        end
    end
})

DragonKillerGroup:AddDivider()
DragonKillerGroup:AddLabel('Targets Fire Dragon boss')
DragonKillerGroup:AddLabel('No NpcMarker needed')

-- UI Settings
Library:SetWatermarkVisibility(false)

-- Unload cleanup
local function Unload()
    if qConnection then qConnection:Disconnect() end
    if eConnection then eConnection:Disconnect() end
    if tpqConnection then tpqConnection:Disconnect() end
    if m1Connection then m1Connection:Disconnect() end
    if smartGachaConnection then smartGachaConnection:Disconnect() end
    if smartGemCapConnection then smartGemCapConnection:Disconnect() end
    if dragonSummonConnection then dragonSummonConnection:Disconnect() end
    if dragonKillerConnection then dragonKillerConnection:Disconnect() end
    Library:Unload()
end

Library:OnUnload(Unload)

print("‚úÖ Auto Q & E Skill script loaded!")
