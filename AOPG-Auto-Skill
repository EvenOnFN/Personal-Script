-- Load Linoria Library
local repo = 'https://raw.githubusercontent.com/violin-suzutsuki/LinoriaLib/main/'
local Library = loadstring(game:HttpGet(repo .. 'Library.lua'))()
local ThemeManager = loadstring(game:HttpGet(repo .. 'addons/ThemeManager.lua'))()
local SaveManager = loadstring(game:HttpGet(repo .. 'addons/SaveManager.lua'))()

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Anti-AFK Setup
local VirtualUser = game:GetService("VirtualUser")
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- Create Window
local Window = Library:CreateWindow({
    Title = 'Auto Skills',
    Center = true,
    AutoShow = true,
    TabPadding = 8,
    MenuFadeTime = 0.2
})

-- Create Tab
local Tabs = {
    Main = Window:AddTab('Main'),
}

-- Variables
local autoQEnabled = false
local autoEEnabled = false
local autoTPQEnabled = false
local autoM1Enabled = false
local autoBuyGacha3Enabled = false
local autoGemCapEnabled = false
local qConnection, eConnection, tpqConnection, m1Connection, buyGacha3Connection, gemCapConnection = nil, nil, nil, nil, nil, nil
local lastQAttackTime, lastEAttackTime, lastTPQAttackTime, lastM1AttackTime = 0, 0, 0, 0
local attackDelay = 0.1
local tpHeight = 5

-- Main Tab Groups
local EscanorSkillGroup = Tabs.Main:AddLeftGroupbox('Escanor')
local TPFarmGroup = Tabs.Main:AddRightGroupbox('TP Farm')
local M1Group = Tabs.Main:AddRightGroupbox('Auto M1')
local AutoBuyGroup = Tabs.Main:AddLeftGroupbox('Buy Christmas Gacha')
local GemCapGroup = Tabs.Main:AddLeftGroupbox('Auto Increase Gem Cap')

-- Function to check if model has NpcMarker
local function hasNpcMarker(model)
    for _, child in pairs(model:GetDescendants()) do
        if child:IsA("BillboardGui") and child.Name == "NpcMarker" then
            return true
        end
    end
    return false
end

-- Function to check if something is a raid mob
local function isRaidMob(model)
    if not model:IsA("Model") then return false end
    if not model:FindFirstChild("Humanoid") then return false end
    if not model:FindFirstChild("HumanoidRootPart") then return false end
    if Players:GetPlayerFromCharacter(model) then return false end
    local humanoid = model:FindFirstChild("Humanoid")
    if humanoid.Health <= 0 then return false end
    if not hasNpcMarker(model) then return false end
    return true
end

-- Function to find nearest raid mob
local function findNearestRaidMob()
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        return nil
    end
    local playerPos = player.Character.HumanoidRootPart.Position
    local nearestMob, nearestDistance = nil, math.huge
    if workspace:FindFirstChild("Entities") then
        for _, model in pairs(workspace.Entities:GetChildren()) do
            if isRaidMob(model) then
                local mobHRP = model:FindFirstChild("HumanoidRootPart")
                if mobHRP then
                    local distance = (playerPos - mobHRP.Position).Magnitude
                    if distance < nearestDistance then
                        nearestDistance = distance
                        nearestMob = model
                    end
                end
            end
        end
    end
    return nearestMob, nearestDistance
end

-- Function to get a suitable target part for abilities
local function getTargetPart()
    if workspace:FindFirstChild("Raid Map") then
        for _, child in pairs(workspace["Raid Map"]:GetChildren()) do
            if child:IsA("MeshPart") and child.Name:find("newcake") then return child end
        end
        for _, child in pairs(workspace["Raid Map"]:GetChildren()) do
            if child:IsA("MeshPart") then return child end
        end
        if workspace["Raid Map"]:FindFirstChild("Model") then return workspace["Raid Map"].Model end
    else
        local dawnIsland = workspace:FindFirstChild("Map") and workspace.Map:FindFirstChild("Islands") and workspace.Map.Islands:FindFirstChild("Dawn Island")
        if dawnIsland and dawnIsland:FindFirstChild("Model") then
            local model = dawnIsland.Model:FindFirstChild("Dawn Island")
            if model and model:FindFirstChild("Model") then
                local meshPart = model.Model:FindFirstChild("Meshes/daniland.2")
                if meshPart then return meshPart end
            end
        end
    end
    return nil
end

-- Function to get skill args
local function getSkillArgs(skill)
    local targetPart = getTargetPart() or workspace
    return {
        "Sword Style",
        skill,
        player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.HumanoidRootPart.CFrame or CFrame.new(0, 0, 0),
        targetPart,
        5
    }
end

-- Function to teleport to position
local function teleportToPosition(targetPosition)
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        player.Character.HumanoidRootPart.CFrame = CFrame.new(targetPosition)
    end
end

-- Function to perform M1 attack
local function performM1()
    pcall(function()
        local args = getSkillArgs("MouseButton1")
        ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(args))
    end)
end

-- Function to buy gacha version 3
local function buyGacha3()
    pcall(function()
        player:WaitForChild("PlayerGui"):WaitForChild("NewPresentShop"):WaitForChild("buy"):FireServer(3)
    end)
end

-- Function to increase gem cap
local function increaseGemCap()
    pcall(function()
        player:WaitForChild("PlayerGui"):WaitForChild("NewPoneglyphMerchant"):WaitForChild("Event"):FireServer(10)
    end)
end

-- Toggle for Auto Q Skill
EscanorSkillGroup:AddToggle('AutoQ', {
    Text = 'Escanor Q',
    Default = false,
    Tooltip = 'Automatically uses Q skill when raid mob detected',
    Callback = function(value)
        autoQEnabled = value
        if value then
            Library:Notify('‚úÖ Escanor Q enabled!')
            qConnection = RunService.Heartbeat:Connect(function()
                if not autoQEnabled then return end
                local currentTime = tick()
                local mob = findNearestRaidMob()
                if mob and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
                    if currentTime - lastQAttackTime >= attackDelay then
                        pcall(function()
                            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("Q")))
                        end)
                        lastQAttackTime = currentTime
                    end
                end
            end)
        else
            Library:Notify('‚ùå Escanor Q disabled.')
            if qConnection then qConnection:Disconnect() qConnection = nil end
        end
    end
})

EscanorSkillGroup:AddDivider()

-- Toggle for Auto E Skill
EscanorSkillGroup:AddToggle('AutoE', {
    Text = 'Escanor E',
    Default = false,
    Tooltip = 'Automatically uses E skill when raid mob detected',
    Callback = function(value)
        autoEEnabled = value
        if value then
            Library:Notify('‚úÖ Escanor E enabled!')
            eConnection = RunService.Heartbeat:Connect(function()
                if not autoEEnabled then return end
                local currentTime = tick()
                local mob = findNearestRaidMob()
                if mob and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
                    if currentTime - lastEAttackTime >= attackDelay then
                        pcall(function()
                            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("E")))
                        end)
                        lastEAttackTime = currentTime
                    end
                end
            end)
        else
            Library:Notify('‚ùå Escanor E disabled.')
            if eConnection then eConnection:Disconnect() eConnection = nil end
        end
    end
})

EscanorSkillGroup:AddDivider()
EscanorSkillGroup:AddLabel('Attacks mobs with NpcMarker')
EscanorSkillGroup:AddLabel('No teleportation')
EscanorSkillGroup:AddDivider()
EscanorSkillGroup:AddLabel('üü¢ Anti-AFK: Active')

-- Toggle for Auto TP + Q Farm
TPFarmGroup:AddToggle('AutoTPQ', {
    Text = 'Auto TP + Q Farm',
    Default = false,
    Tooltip = 'Teleports to raid mob and uses Q skill',
    Callback = function(value)
        autoTPQEnabled = value
        if value then
            Library:Notify('‚úÖ Auto TP + Q Farm enabled!')
            tpqConnection = RunService.Heartbeat:Connect(function()
                if not autoTPQEnabled then return end
                local currentTime = tick()
                local mob = findNearestRaidMob()
                if mob and mob:FindFirstChild("Humanoid") and mob:FindFirstChild("HumanoidRootPart") and mob.Humanoid.Health > 0 then
                    teleportToPosition(mob.HumanoidRootPart.Position + Vector3.new(0, tpHeight, 0))
                    if currentTime - lastTPQAttackTime >= attackDelay then
                        pcall(function()
                            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("requestAbility"):FireServer(unpack(getSkillArgs("Q")))
                        end)
                        lastTPQAttackTime = currentTime
                    end
                end
            end)
        else
            Library:Notify('‚ùå Auto TP + Q Farm disabled.')
            if tpqConnection then tpqConnection:Disconnect() tpqConnection = nil end
        end
    end
})

TPFarmGroup:AddDivider()
TPFarmGroup:AddLabel('Teleports to mob')
TPFarmGroup:AddLabel('Uses Q skill')

-- Toggle for Auto M1
M1Group:AddToggle('AutoM1', {
    Text = 'Auto M1 (Sword Style)',
    Default = false,
    Tooltip = 'Automatically spams Sword Style M1 at all times',
    Callback = function(value)
        autoM1Enabled = value
        if value then
            Library:Notify('‚úÖ Auto M1 enabled!')
            m1Connection = RunService.Heartbeat:Connect(function()
                if not autoM1Enabled then return end
                performM1()
            end)
        else
            Library:Notify('‚ùå Auto M1 disabled.')
            if m1Connection then m1Connection:Disconnect() m1Connection = nil end
        end
    end
})

M1Group:AddDivider()
M1Group:AddLabel('Uses Sword Style M1')
M1Group:AddLabel('Spams constantly')
M1Group:AddLabel('No mob detection needed')

-- Toggle for Auto Buy Gacha Version 3
AutoBuyGroup:AddToggle('AutoBuyGacha3', {
    Text = 'Buy Christmas Gacha',
    Default = false,
    Tooltip = 'Automatically buys Christmas Gacha with no delay',
    Callback = function(value)
        autoBuyGacha3Enabled = value
        if value then
            Library:Notify('‚úÖ Auto Buy Christmas Gacha enabled!')
            buyGacha3Connection = RunService.Heartbeat:Connect(function()
                if not autoBuyGacha3Enabled then return end
                buyGacha3()
            end)
        else
            Library:Notify('‚ùå Auto Buy Christmas Gacha disabled.')
            if buyGacha3Connection then buyGacha3Connection:Disconnect() buyGacha3Connection = nil end
        end
    end
})

AutoBuyGroup:AddDivider()
AutoBuyGroup:AddLabel('Spams buy with no delay')
AutoBuyGroup:AddLabel('‚ö†Ô∏è Use carefully!')

-- Toggle for Auto Increase Gem Cap
GemCapGroup:AddToggle('AutoGemCap', {
    Text = 'Auto Increase Gem Cap',
    Default = false,
    Tooltip = 'Automatically increases gem cap with no delay',
    Callback = function(value)
        autoGemCapEnabled = value
        if value then
            Library:Notify('‚úÖ Auto Increase Gem Cap enabled!')
            gemCapConnection = RunService.Heartbeat:Connect(function()
                if not autoGemCapEnabled then return end
                increaseGemCap()
            end)
        else
            Library:Notify('‚ùå Auto Increase Gem Cap disabled.')
            if gemCapConnection then gemCapConnection:Disconnect() gemCapConnection = nil end
        end
    end
})

GemCapGroup:AddDivider()
GemCapGroup:AddLabel('Increases gem capacity')
GemCapGroup:AddLabel('Spams with no delay')

-- UI Settings
Library:SetWatermarkVisibility(true)
Library:SetWatermark('Auto Skills')

-- Unload cleanup
local function Unload()
    if qConnection then qConnection:Disconnect() end
    if eConnection then eConnection:Disconnect() end
    if tpqConnection then tpqConnection:Disconnect() end
    if m1Connection then m1Connection:Disconnect() end
    if buyGacha3Connection then buyGacha3Connection:Disconnect() end
    if gemCapConnection then gemCapConnection:Disconnect() end
    Library:Unload()
end

Library:OnUnload(Unload)

print("‚úÖ Auto Q & E Skill script loaded!")
